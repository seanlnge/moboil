---
import SiteLayout from "../components/SiteLayout.astro";
import BookingForm from "../components/BookingForm";
import { FlickeringGrid } from "~/components/aesthetic/flickering-grid";
---

<SiteLayout title="Book an Oil Change | Moboil" description="Book a mobile oil change with Moboil. We come to your location in the Tampa area." current="booking">
	<section class="bg-black w-full min-h-[40vh] flex flex-col items-center text-m-white relative overflow-hidden">
		<img src="/media/oil.webp" alt="Background" class="absolute inset-0 w-full h-full object-cover z-0" />
		<div class="absolute inset-0 bg-black/90 z-10"></div>
		<div class="relative z-20 w-full max-w-6xl px-6 md:px-12 lg:px-16 pt-28 pb-16 text-center">
			<p class="uppercase tracking-[0.35em] text-xs font-semibold text-orange-400/80 mb-4">
				Book Now
			</p>
			<h1 class="font-header text-4xl md:text-5xl lg:text-6xl font-semibold text-m-white">
				Schedule your oil change.
			</h1>
			<div id="booking-warning" class="hidden mt-6 bg-yellow-500/10 border border-yellow-500/50 text-yellow-200 p-4 rounded-lg max-w-xl mx-auto text-left backdrop-blur-sm">
				<p class="font-bold text-yellow-400 flex items-center gap-2">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-clock"><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="M21 17h-5"/><path d="m19 17 1.5 1.5"/></svg>
					Existing Booking
				</p>
				<p class="mt-1 text-sm">You already have a booking scheduled for <span id="booking-date-display" class="font-semibold text-white"></span>.</p>
			</div>
			<p class="mt-4 text-base md:text-lg text-slate-300 leading-relaxed max-w-xl mx-auto">
				Pick a time, give us a location, and we'll handle the rest. Done in under 30 minutes for a flat $87.
			</p>
		</div>
	</section>

	<section class="relative z-30 bg-m-white py-16 md:py-24 px-6 md:px-12">
		<FlickeringGrid
			client:load
			className="-z-10 absolute inset-0 size-full w-full h-full"
			squareSize={4}
			gridGap={6}
			color="#cba"
			maxOpacity={0.3}
			flickerChance={0.3}
		/>
		<BookingForm client:load />
	</section>

	<script>
		function checkBooking() {
			const bookingData = localStorage.getItem('moboil_booking');
			if (bookingData) {
				try {
					const { date, time } = JSON.parse(bookingData);
					if (date) {
						// Parse YYYY-MM-DD manually to avoid UTC issues
						const [y, m, d] = date.split('-').map(Number);
						const bookingDay = new Date(y, m - 1, d);
						
						const now = new Date();
						const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

						// Check if booking is today or in the future
						if (bookingDay >= today) {
							const warningEl = document.getElementById('booking-warning');
							const dateDisplay = document.getElementById('booking-date-display');
							if (warningEl && dateDisplay) {
								// Format date nicely
								const formattedDate = bookingDay.toLocaleDateString('en-US', { 
									weekday: 'long', 
									year: 'numeric', 
									month: 'long', 
									day: 'numeric' 
								});
								
								// Capitalize time
								const formattedTime = time ? time.charAt(0).toUpperCase() + time.slice(1) : '';
								
								dateDisplay.textContent = `${formattedDate} ${formattedTime ? `(${formattedTime})` : ''}`;
								warningEl.classList.remove('hidden');
							}
						}
					}
				} catch (e) {
					console.error("Error parsing booking data", e);
				}
			}
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', checkBooking);
		} else {
			checkBooking();
		}
	</script>
</SiteLayout>
